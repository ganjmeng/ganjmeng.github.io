
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Block 高级进阶 | 感觉萌的Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Gan Meng">
    

    
    <meta name="description" content="Block学习笔记

Block的类型与内存管理

根据Block在内存中的位置分为三种类型
NSGlobalBlock：类似函数，位于text段，全局的静态 block，不会访问任何外部变量
NSStackBlock：保存在栈中的 block，当函数返回时会被销毁
NSMallocBlock：保存在堆中的 block，当引用计数为 0 时会被销毁。



在MRC和ARC下还是有区别的
MR">
<meta property="og:type" content="article">
<meta property="og:title" content="Block 高级进阶">
<meta property="og:url" content="http://ganmmeng.cn/2016/06/16/untitled-1466044983663/index.html">
<meta property="og:site_name" content="感觉萌的Blog">
<meta property="og:description" content="Block学习笔记

Block的类型与内存管理

根据Block在内存中的位置分为三种类型
NSGlobalBlock：类似函数，位于text段，全局的静态 block，不会访问任何外部变量
NSStackBlock：保存在栈中的 block，当函数返回时会被销毁
NSMallocBlock：保存在堆中的 block，当引用计数为 0 时会被销毁。



在MRC和ARC下还是有区别的
MR">
<meta property="og:image" content="http://7xtu7q.com1.z0.glb.clouddn.com/16-5-12/7638807.jpg">
<meta property="og:updated_time" content="2016-06-16T02:56:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Block 高级进阶">
<meta name="twitter:description" content="Block学习笔记

Block的类型与内存管理

根据Block在内存中的位置分为三种类型
NSGlobalBlock：类似函数，位于text段，全局的静态 block，不会访问任何外部变量
NSStackBlock：保存在栈中的 block，当函数返回时会被销毁
NSMallocBlock：保存在堆中的 block，当引用计数为 0 时会被销毁。



在MRC和ARC下还是有区别的
MR">
<meta name="twitter:image" content="http://7xtu7q.com1.z0.glb.clouddn.com/16-5-12/7638807.jpg">

    
    <link rel="alternative" href="/atom.xml" title="感觉萌的Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="感觉萌的Blog" title="感觉萌的Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="感觉萌的Blog">感觉萌的Blog</a></h1>
				<h2 class="blog-motto">欲罢不能，想想都有点小激动。</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:ganmmeng.cn">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/16/untitled-1466044983663/" title="Block 高级进阶" itemprop="url">Block 高级进阶</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Gan Meng" target="_blank" itemprop="author">Gan Meng</a>
		
  <p class="article-time">
    <time datetime="2016-06-16T02:43:03.000Z" itemprop="datePublished"> Published 2016-06-16</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Block的类型与内存管理"><span class="toc-number">1.</span> <span class="toc-text">Block的类型与内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MRC-下的-Block的三种类型"><span class="toc-number">1.1.</span> <span class="toc-text">MRC 下的 Block的三种类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARC-下的-Block"><span class="toc-number">1.2.</span> <span class="toc-text">ARC 下的 Block</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tips"><span class="toc-number">2.</span> <span class="toc-text">Tips</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Objective-C-Blocks-Quiz"><span class="toc-number">3.</span> <span class="toc-text">Objective-C Blocks Quiz</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-A"><span class="toc-number">3.1.</span> <span class="toc-text">Example A</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-B"><span class="toc-number">3.2.</span> <span class="toc-text">Example B</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-C"><span class="toc-number">3.3.</span> <span class="toc-text">Example C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-D"><span class="toc-number">3.4.</span> <span class="toc-text">Example D</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-E"><span class="toc-number">3.5.</span> <span class="toc-text">Example E</span></a></li></ol></li></ol>
		
		</div>
		
		<p><img src="http://7xtu7q.com1.z0.glb.clouddn.com/16-5-12/7638807.jpg" alt=""></p>
<blockquote>
<p>Block学习笔记</p>
</blockquote>
<h2 id="Block的类型与内存管理"><a href="#Block的类型与内存管理" class="headerlink" title="Block的类型与内存管理"></a>Block的类型与内存管理</h2><hr>
<ul>
<li>根据Block在内存中的位置分为三种类型<ul>
<li><code>NSGlobalBlock</code>：类似函数，位于text段，全局的静态 block，不会访问任何外部变量</li>
<li><code>NSStackBlock</code>：保存在栈中的 block，当函数返回时会被销毁</li>
<li><code>NSMallocBlock</code>：保存在堆中的 block，当引用计数为 0 时会被销毁。</li>
</ul>
</li>
</ul>
<p>在MRC和ARC下还是有区别的</p>
<h3 id="MRC-下的-Block的三种类型"><a href="#MRC-下的-Block的三种类型" class="headerlink" title="MRC 下的 Block的三种类型"></a>MRC 下的 Block的三种类型</h3><hr>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*------------在MRC下-----------------*/</span></span><br><span class="line">    <span class="keyword">typedef</span> test (^MyBlock)(<span class="keyword">int</span>, <span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">    MyBlock block1 = ^ test (<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"block1 = %@"</span>, block1);</span><br><span class="line">    <span class="comment">// block1 = &lt;__NSGlobalBlock__: 0x86f0&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> temp = <span class="number">100</span>;</span><br><span class="line">    MyBlock block2 = ^ test (<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">        <span class="keyword">return</span> temp + a + b;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"block2 = %@"</span>, block2);</span><br><span class="line">    <span class="comment">// block2 = &lt;__NSStackBlock__: 0xddf24a1&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//copy</span></span><br><span class="line">    MyBlock block3 = [[block2 <span class="keyword">copy</span>] autorelease];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"block3 = %@"</span>, block3);</span><br><span class="line">    <span class="comment">// block3 = &lt;__NSMallocBlock__: 0x75425a0&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>block1</code>没有使用任何<code>外部变量</code>，因此存储在 <code>代码区</code>，编译器给其的类型为<code>NSGlobalBlock</code><br><code>block2</code>使用到了局部变量，在<code>定义</code>（注意是定义，不是运行）block2时，局部变量<code>temp</code>当前值被copy到栈上，作为<code>常量</code>供Block使用(之前有提过，所以在block中不可以随意修改外面定义的局部变量)。编译器给其类型为<code>NSStackBlock</code><br><code>block3</code> 经过拷贝，局部变量 <code>temp</code> 的值被 copy 到堆中，编译器给其类型为<code>NSMallocBlock</code> 总结说来，<code>block 的类型</code>取决于内部使用的变量在哪。</p>
</blockquote>
<h3 id="ARC-下的-Block"><a href="#ARC-下的-Block" class="headerlink" title="ARC 下的 Block"></a>ARC 下的 Block</h3><hr>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*------------在ARC下-----------------*/</span></span><br><span class="line"><span class="keyword">typedef</span> test (^MyBlock)(<span class="keyword">int</span>, <span class="keyword">int</span>);</span><br><span class="line">MyBlock block1 = ^ test (<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"block1 = %@"</span>, block1);</span><br><span class="line"><span class="comment">// block1 = &lt;__NSGlobalBlock__: 0x10010030&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> temp = <span class="number">100</span>;</span><br><span class="line">MyBlock block2 = ^ test (<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">  <span class="keyword">return</span> temp + a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"block2 = %@"</span>, block2);</span><br><span class="line"><span class="comment">// block2 = &lt;__NSMallocBlock__: 0x100102df0&gt;</span></span><br><span class="line"></span><br><span class="line">__block <span class="keyword">int</span> sum = <span class="number">100</span>;</span><br><span class="line">MyBlock block3 = ^ test (<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">  <span class="keyword">return</span> sum + a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"block3 = %@"</span>, block3);</span><br><span class="line"><span class="comment">// block3 = &lt;__NSMallocBlock__: 0x100306110&gt;</span></span><br></pre></td></tr></table></figure>
<p>因为 <code>ARC</code> 下，编译器帮我们管理内存，所以只要<code>内部调用了外部变量</code>，编译器都会 <code>copy</code>一份变量到<code>堆</code>中，并且引用计数增加。 所以<code>block2</code>和<code>block3</code>的类型都是<code>NSMallocBlock</code>。其余和 <code>MRC</code>一样。</p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><blockquote>
<p><strong><code>Tips</code></strong>:<br><strong>以下情况，block 会拷贝到堆：</strong><br><code>*</code>当 <code>block</code> 调用 <code>copy</code>方法时，如果<code>block 在栈上</code>，会被拷贝到<code>堆</code>上；<br><code>*</code>当 <code>block</code> 作为<code>函数返回值返回</code>时，编译器自动调用<code>copy</code>方法；<br><code>*</code>当 block 被赋值给<code>_strong id</code>类型的对象或<code>block 的成员变量</code>时，编译器自动将 block 作为<code>Block_copy</code>函数，效果等同于 block 直接调用<code>copy</code>方法；<br><code>*</code>当<code>block</code>作为参数被传入方法名带有<code>usingBlock</code> 的<code>Cocoa Framework</code>方法或 <code>GCD</code>的<code>API</code> 时。这些方法会在内部对传递进来的 block 调用<code>copy</code>或<code>_Block_copy</code>进行拷贝;</p>
</blockquote>
<a id="more"></a>
<hr>
<h2 id="Objective-C-Blocks-Quiz"><a href="#Objective-C-Blocks-Quiz" class="headerlink" title="Objective-C Blocks Quiz"></a>Objective-C Blocks Quiz</h2><hr>
<h3 id="Example-A"><a href="#Example-A" class="headerlink" title="Example A"></a>Example A</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> exampleA() &#123;</span><br><span class="line">  <span class="keyword">char</span> a = <span class="string">'A'</span>;</span><br><span class="line">  ^&#123;</span><br><span class="line">    printf(<span class="string">"%cn"</span>, a);</span><br><span class="line">  &#125;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Always works</p>
<blockquote>
<p>Explain<br>This always works. The stack for exampleA doesn’t go away until after the block has finished executing. So whether the block is allocated on the stack or the heap, it will be valid when it is executed.</p>
</blockquote>
<p>  直到 <code>block</code> 运行结束之前，    函数<code>exampleA</code>不会消失，所以不管 block 在堆中还是栈中，它在执行时都是有效的。</p>
</li>
</ul>
<h3 id="Example-B"><a href="#Example-B" class="headerlink" title="Example B"></a>Example B</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> exampleB_addBlockToArray(<span class="built_in">NSMutableArray</span> *array) &#123;</span><br><span class="line">  <span class="keyword">char</span> b = <span class="string">'B'</span>;</span><br><span class="line"><span class="comment">//add a block as a object</span></span><br><span class="line">  [array addObject:^&#123;</span><br><span class="line">    printf(<span class="string">"%cn"</span>, b);</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> exampleB() &#123;</span><br><span class="line">  <span class="built_in">NSMutableArray</span> *array = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">  exampleB_addBlockToArray(array);</span><br><span class="line">  <span class="keyword">void</span> (^block)() = [array objectAtIndex:<span class="number">0</span>];</span><br><span class="line">  block();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Only works in ARC</p>
<blockquote>
<p>Explain<br>Without ARC, the block is an NSStackBlock allocated on the stack of exampleB_addBlockToArray. By the time it executes in exampleB, the the block is no longer valid, because that stack has been cleared.<br>With ARC, the block is properly allocated on the heap as an autoreleased NSMallocBlock to begin with.</p>
</blockquote>
<p>  在 <code>MRC</code>中，<code>block</code>是<code>exampleB_addBlockToArray</code>的栈上分配一个<code>NSStackBlock</code> 。它在exampleB执行时，它已经被释放掉了，换一种说法：这里的<code>block 存在栈中</code>，所以在执行<code>exampleB</code>函数的<code>exampleB_addBlockToArray(array);</code>之后，b 变量变得无效，所以[array objectAtIndex:0]不能成功。 在 <code>ARC</code>中，这个 <code>block</code> 存在堆中类型为<code>NSMallocBlock</code>，当运行到<code>[array objectAtIndex:0]</code>，block 还<code>没被释放</code>，所以可以运行。</p>
</li>
</ul>
<h3 id="Example-C"><a href="#Example-C" class="headerlink" title="Example C"></a>Example C</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> exampleC_addBlockToArray(<span class="built_in">NSMutableArray</span> *array) &#123;</span><br><span class="line">  [array addObject:^&#123;</span><br><span class="line">    printf(<span class="string">"Cn"</span>);</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> exampleC() &#123;</span><br><span class="line">  <span class="built_in">NSMutableArray</span> *array = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">  exampleC_addBlockToArray(array);</span><br><span class="line">  <span class="keyword">void</span> (^block)() = [array objectAtIndex:<span class="number">0</span>];</span><br><span class="line">  block();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Always works</p>
<blockquote>
<p>Explain<br>Since the block doesn’t capture any variables in its closure, it doesn’t need any state set up at runtime. it gets compiled as an NSGlobalBlock. It’s neither on the stack nor the heap, but part of the code segment, like any C function. This works both with and without ARC.</p>
</blockquote>
<p>  由于该<code>Block</code>没有访问任何变量，它并不需要在运行时设置的任何状态。它被编译为一个<code>NSGlobalBlock</code> 。它既在栈上也不再堆上,所以不管是 ARC 还是 MRC 都是可以用的。</p>
</li>
</ul>
<h3 id="Example-D"><a href="#Example-D" class="headerlink" title="Example D"></a>Example D</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^dBlock)();</span><br><span class="line"></span><br><span class="line">dBlock exampleD_getBlock() &#123;</span><br><span class="line">  <span class="keyword">char</span> d = <span class="string">'D'</span>;</span><br><span class="line">  <span class="keyword">return</span> ^&#123;</span><br><span class="line">    printf(<span class="string">"%cn"</span>, d);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> exampleD() &#123;</span><br><span class="line">  exampleD_getBlock()();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Only works in ARC</p>
<blockquote>
<p>Explain<br>This is similar to example B. Without ARC, the block would be created on the stack of exampleD_getBlock and then immediately become invalid when that function returns. However, in this case, the error is so obvious that the compiler will fail to compile, with the error error: returning block that lives on the local stack.<br>With ARC, the block is correctly placed on the heap as an autoreleased NSMallocBlock.</p>
</blockquote>
<p>  类似于<code>example B</code>, 在 <code>MRC</code> 时，block 会被创建在栈中，所以当block 返回时，马上失效。在这种情况下，错误是显而易见的，编译器无法编译成功。返回一个错误：<code>returning block that lives on the local stack。</code> 在 ARC 中，当自动释放池<code>销毁</code>，block 才失效</p>
</li>
</ul>
<h3 id="Example-E"><a href="#Example-E" class="headerlink" title="Example E"></a>Example E</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^eBlock)();</span><br><span class="line"></span><br><span class="line">eBlock exampleE_getBlock() &#123;</span><br><span class="line">  <span class="keyword">char</span> e = <span class="string">'E'</span>;</span><br><span class="line">  <span class="keyword">void</span> (^block)() = ^&#123;</span><br><span class="line">    printf(<span class="string">"%cn"</span>, e);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> exampleE() &#123;</span><br><span class="line">  eBlock block = exampleE_getBlock();</span><br><span class="line">  block();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Only works in ARC</p>
<blockquote>
<p>Explain<br>This is just like example D, except that the compiler doesn’t recognize it as an error, so this code compiles and crashes. Even worse, this particular example happens to work fine if you disable optimizations. So watch out for this working while testing and failing in production.<br>With ARC, the block is correctly placed on the heap as an autoreleased NSMallocBlock.</p>
</blockquote>
<p>  类似于上一个例子，在 MRC 会造成崩溃。<br><a href="http://blog.parse.com/learn/engineering/objective-c-blocks-quiz/" target="_blank" rel="external">参考资料  Bryan Klimt — February 5th, 2013 —Objective-C Blocks Quiz</a></p>
</li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS开发/">iOS开发</a>►<a class="article-category-link" href="/categories/iOS开发/Block/">Block</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS开发/">iOS开发</a><a href="/tags/Block/">Block</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://ganmmeng.cn/2016/06/16/untitled-1466044983663/" data-title="Block 高级进阶 | 感觉萌的Blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/06/20/untitled-1466390002267/" title="[转载]Eclipse for Mac 常用快捷键">
  <strong>上一篇：</strong><br/>
  <span>
  [转载]Eclipse for Mac 常用快捷键</span>
</a>
</div>


<div class="next">
<a href="/2016/06/14/untitled-1465894965705/"  title="Block中级进阶（下）—— 循环引用">
 <strong>下一篇：</strong><br/> 
 <span>Block中级进阶（下）—— 循环引用
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Block的类型与内存管理"><span class="toc-number">1.</span> <span class="toc-text">Block的类型与内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MRC-下的-Block的三种类型"><span class="toc-number">1.1.</span> <span class="toc-text">MRC 下的 Block的三种类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARC-下的-Block"><span class="toc-number">1.2.</span> <span class="toc-text">ARC 下的 Block</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tips"><span class="toc-number">2.</span> <span class="toc-text">Tips</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Objective-C-Blocks-Quiz"><span class="toc-number">3.</span> <span class="toc-text">Objective-C Blocks Quiz</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-A"><span class="toc-number">3.1.</span> <span class="toc-text">Example A</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-B"><span class="toc-number">3.2.</span> <span class="toc-text">Example B</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-C"><span class="toc-number">3.3.</span> <span class="toc-text">Example C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-D"><span class="toc-number">3.4.</span> <span class="toc-text">Example D</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-E"><span class="toc-number">3.5.</span> <span class="toc-text">Example E</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/ALL/" title="ALL">ALL<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS开发/Block/" title="Block">Block<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/Eclipse/" title="Eclipse">Eclipse<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS开发/Runtime/" title="Runtime">Runtime<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/blog/" title="blog">blog<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/hexo/" title="hexo">hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS开发/" title="iOS开发">iOS开发<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS开发/" title="iOS开发">iOS开发<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Block/" title="Block">Block<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/杂/" title="杂">杂<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/hexo/" title="hexo">hexo<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/blog/" title="blog">blog<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Runtime/" title="Runtime">Runtime<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Eclipse/" title="Eclipse">Eclipse<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=1a810af34eac8772&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m GanMeng in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1752287957" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="Gan Meng">Gan Meng</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
